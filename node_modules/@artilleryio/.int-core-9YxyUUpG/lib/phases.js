/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

'use strict';

const EventEmitter = require('eventemitter3');
const async = require('async');
const _ = require('lodash');
const isUndefined = _.isUndefined;
const arrivals = require('arrivals');
const debug = require('debug')('phases');
const { randomUUID } = require('crypto');
const driftless = require('driftless');
const ms = require('ms');

module.exports = phaser;

async function sleep(ms) {
  return new Promise((resolve) => {
    setTimeout(resolve, ms);
  });
}

function phaser(phaseSpecs) {
  let ee = new EventEmitter();

  let tasks = _.map(phaseSpecs, function (spec, i) {
    [
      'arrivalRate',
      'arrivalCount',
      'pause',
      'rampTo',
      'duration',
      'maxVusers'
    ].forEach(function (k) {
      if (isUndefined(spec[k]) || spec[k] == 'number') {
        return;
      }

      if (k == 'duration' || k == 'pause') {
        //if it's already a number in string format, don't apply ms, as it's the default behaviour, so we don't want to do ms calculations
        //otherwise, ms returns the value in milliseconds, so we need to convert to seconds
        const convertedDuration = Number.isInteger(_.toNumber(spec[k]))
          ? spec[k]
          : ms(spec[k]) / 1000;

        //throw error if invalid time format to prevent test from running infinitely
        if (!convertedDurati