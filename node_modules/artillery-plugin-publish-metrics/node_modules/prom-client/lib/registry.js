'use strict';
const { getValueAsString } = require('./util');

function escapeString(str) {
	return str.replace(/\n/g, '\\n').replace(/\\(?!n)/g, '\\\\');
}
function escapeLabelValue(str) {
	if (typeof str !== 'string') {
		return str;
	}
	return escapeString(str).replace(/"/g, '\\"');
}

class Registry {
	constructor() {
		this._metrics = {};
		this._collectors = [];
		this._defaultLabels = {};
	}

	getMetricsAsArray() {
		return Object.values(this._metrics);
	}

	async getMetricAsPrometheusString(metric) {
		const item = await metric.get();
		const name = escapeString(item.name);
		const help = `# HELP ${name} ${escapeString(item.help)}`;
		const type = `# TYPE ${name} ${item.type}`;
		const defaultLabels =
			Object.keys(this._defaultLabels).length > 0 ? this._defaultLabels : null;

		const values = [help, type];
		for (const { metricName = item.name, value, labels = {} } of item.values ||
			[]) {
			const labelsWithDefaults = defaultLabels
				? { ...labels, ...defaultLabels, ...labels }
				: labels;

			const formattedLabels = Object.entries(labelsWithDefaults).map(
				([n, v]) => `${n}="${escapeLabelValue(v)}"`,
			);
			const labelsString = formattedLabels.length
				? `{${formattedLabels.join(',')}}`
				: '';

			values.push(`${metricName}${labelsString} ${getValueAsString(value)}`);
		}

		return values.join('\n');
	}

	async metrics() {
		const promises = [];

		for (const metric of this.getMetricsAsArray()) {
			promises.push(this.getMetricAsPrometheusString(metric));
		}

		const resolves = awai